(function($) {
	
	jQuery.fn._scroll = function() {	
		var $el = this,
<<<<<<< HEAD
				_top = 0,
				slider = 0,
				$slide = null;
				$gistogramma = $('.gistogramma'),
				$favorite = $('.favorite'),
				max_top = ($('.slide').length-1)*-100,
				distance = 100;
				
				var callback = function(e) {
					e.preventDefault();
					$slide = $('.slide').eq(slider);
					
					var $target = $(e.target);
					if (!$target.hasClass('slide-'+slider) &&  $target.parents('.slide-'+slider).length==0 || $el.hasClass('_scroll')) {
						return false;						
					}	
											
					if (e.originalEvent.wheelDelta > 0 || e.originalEvent.detail < 0) {	
						if (_top == 0) return;
						_top+= distance;
					}	
					else {
						if (_top == max_top) return;
						_top-= distance;
					}
					$el.addClass('_scroll');
					_animateSlide();
					setTimeout(function(){$el.removeClass('_scroll');}, 300);			
				};
				 
				$(document).on('mousewheel wheel', function(e){callback(e)});
				
				//$el.on('mousewheel wheel', function(e){callback(e)});
				
			 	
				$(document).on('keyup', function(e) {
					if ($el.hasClass('_scroll')) return false;
	 				var code = (e.charCode) ? e.charCode : e.keyCode;
	 				switch(code) {
				    case 38:
				    	if (_top == 0) return;
							_top+= distance;
							$el.addClass('_scroll');
							_animateSlide();
							setTimeout(function(){$el.removeClass('_scroll');}, 300);							
				    break; 
				    case 32: case 40:
							if (_top == max_top) return false;
							_top-= distance;
							$el.addClass('_scroll');
							_animateSlide();
							setTimeout(function(){$el.removeClass('_scroll');}, 300);
				    break; 	 					
	 				}					
				});
			
			/*switch (slider) {
				case 0:
					distance = 100;	
				break;
				case 1:
					distance = 100;	
					step = 500*Math.abs(wheelDistance(e));
					var _width = $gistogramma.width();
					if (_width<2000) {
						distance = 0;
						if (_width+step>2000) step = 2000 - _width;
		   			$gistogramma.animate({
		   				width: _width+step
		   				}, 
		   				500, 
		   				function(){bStarted = false}
		   			);						
					}
					else {
		   			$gistogramma.animate({
		   				width: 0
		   				}, 
		   				100, 
		   				function(){
		   					bStarted = false
		   				}
		   			);						
					}  	
				break;
				case 2:
					distance = 100;
					step = 19*Math.abs(wheelDistance(e));	
					if (top_percentage<50) {
						$favorite.show();
						distance = 0;
						if (top_percentage+step > 50 ) step = 50 - top_percentage;
						top_percentage +=step;
		   			$favorite.animate({
		   				top: top_percentage+'%'
		   				}, 
		   				200, 
		   				function(){bStarted = false;}
		   			);
		   			if (top_percentage == 50) {
		   				$('.favorite-shadow').animate({
			   				opacity: 1
			   				}, 
			   				200, 
			   				function(){}
		   				);
		   			}						
					}
					else {
						top_percentage = -26;
						$favorite.hide().css('top', '-26%');
						$('.favorite-shadow').css('opacity', 0);		
					}									
				break;
				case 3:
				break;
				case 4:
				break;																
			}*/     
		//});	
		
    function _animateSlide() {
      $el.css({
      	"webkitTransform":"translate3d(0px, "+_top+"%,  0px)",
        "MozTransform":"translate3d(0px, "+_top+"%, 0px)",
        "msTransform":"translate3d(0px, "+_top+"%, 0px)",
        "-ms-transform":"translate(0px, "+_top+"%)",              
        "OTransform":"translate(0px, "+_top+"%)",
        "transform":"translate(0px, "+_top+"%)",
        "transition-timing-function": "ease",
  			"transition-duration": "0.3s"
  		});
  		
  		var next_slider = Math.abs(_top/100); 
  		animate_iphone_content(slider, next_slider);		
  		slider = Math.abs(_top/100);
  		
  		if (slider == 1 ) {
  			$('.iphone-wrapper').css({'opacity': 1});
  			$('.slide-2 .content .iphone_').css('opacity', 0);
  			$('.iphone-wrapper').css('z-index', 1001);  			
  		}
  		if (slider == 0|| slider == 2) { 
  			$('.gistogramma').animate({'opacity':0}, 200, function(){$('.gistogramma').css('width', 0)});	
  		}
  		if (slider == 2 ) {
  			$('.iphone-wrapper').css('z-index', 1001);
  		}  		 		
  		setTimeout(function(){
  			if (slider == 1) { 			
  				$('.gistogramma').css('opacity', 1).animate({'width': 2000}, 300, function(){});
  				$favorite.css('top', '-50%');
  				$('.favorite-shadow').css('opacity', 0);
  				$('.iphone-wrapper').css({'z-index': 1000});
  			}
  			if (slider == 2) {
  				$('.slide-2 .content .iphone_').css('opacity', 1); 				
  				$('.iphone-wrapper').css({'opacity': 0, 'z-index': 1000});
  				$('.slider .slide-3 .clouds-glare').css('opacity', 1);
  				$('.background-wrapper').removeClass('slide-3');
  				$('.slider .slide-3').addClass('with-background-slide3');
		   		$favorite.animate({
		   				top: '50%'
		   			}, 
		   			400, 
		   			function(){
		   				$('.favorite-shadow').animate({
			   				opacity: 1
			   				}, 
			   				50, 
			   				function(){}
		   				);
		   			}
		   		);  				
  			}
  			if (slider == 3) {
  				$('.background-wrapper').addClass('slide-3');
  				$('.slider .slide-3').removeClass('with-background-slide3');
  				$('.slider .slide-3 .clouds-glare').css('opacity', 0);
	  			$favorite.css('top', '-50%');
	  			$('.favorite-shadow').css('opacity', 0);  				
  			}			
  		}, 300);
  		if (slider == 3) {
 				if ($('.background-wrapper .background-slide3').css('opacity')==0) {
		  		$('.background-wrapper .background-slide3').css({
		  			opacity: 1,
		    		WebkitTransition : 'opacity 0.1s ease-in-out',
		    		MozTransition    : 'opacity 0.1s ease-in-out',
		    		MsTransition     : 'opacity 0.1s ease-in-out',
		    		OTransition      : 'opacity 0.1s ease-in-out',
		    		transition       : 'opacity 0.1s ease-in-out'
					});
		  		$('.background-wrapper .background-slide4').css({
		  			opacity: 0,
		    		WebkitTransition : 'opacity 0.1s ease-in-out',
		    		MozTransition    : 'opacity 0.1s ease-in-out',
		    		MsTransition     : 'opacity 0.1s ease-in-out',
		    		OTransition      : 'opacity 0.1s ease-in-out',
		    		transition       : 'opacity 0.1s ease-in-out'
					});	  					
  			}  			
  		}
  		if (slider == 4) {
  			$('.background-wrapper .background-slide3').css({
  				opacity: 0,
    			WebkitTransition : 'opacity 0.1s ease-in-out',
    			MozTransition    : 'opacity 0.1s ease-in-out',
    			MsTransition     : 'opacity 0.1s ease-in-out',
    			OTransition      : 'opacity 0.1s ease-in-out',
    			transition       : 'opacity 0.1s ease-in-out'
				});
  			$('.background-wrapper .background-slide4').css({
  				opacity: 1,
    			WebkitTransition : 'opacity 0.1s ease-in-out',
    			MozTransition    : 'opacity 0.1s ease-in-out',
    			MsTransition     : 'opacity 0.1s ease-in-out',
    			OTransition      : 'opacity 0.1s ease-in-out',
    			transition       : 'opacity 0.1s ease-in-out'
				});					
  		}  		        	
    }
=======
				option = {
					_width: $('body').width(), 
					_height: $('body').height(),
					slides: {from: {num: 0, 'visible': 100}, to: {num: 1, 'visible': 0}}, // 0 to 1
					deltaY: 0,
					position: {_top: 0, toUp: false, toDown: false},
					arc: {sAngle: 0, centerX: 0, centerY: 0, radius: 0}
				};			

		arcDraw();		
	
    $($el).scroll(function() {
   		if ($(this).scrollTop() > option.position._top) {
   			option.position.toDown = true;
   			option.position.toUp = !option.position.toDown;	
   		}
   		else {
   			option.position.toUp = true;
   			option.position.toDown = !option.position.toUp;	   				
   		}
   		//Рассчёт шага скролла в процентах
   		
    	option.position._top = $(this).scrollTop();
    	
    	//Рассчёт текущего и следующего номера слайда
    	option.slides.to.num = (option.position.toDown == true)?Math.ceil(option.position._top/option._height):Math.floor(option.position._top/option._height);
    	option.slides.from.num = (option.position.toDown == true)?option.slides.to.num-1:option.slides.to.num+1;
    	
    	//Рассчёт процента видимости слайдов
    	var num = option.slides.from.num,
    			_max = 100;
    	
    	if (option.position.toUp)  { 
    		num = option.slides.to.num;  
    		_max=0;
    	}
    	
    	var odlVisible = option.slides.to.visible;
    	
    	//Рассчёт процентов видимости текущего и следующего слайда
    	option.slides.from.visible = Math.round((Math.abs(_max-(option.position._top-option._height*num)/option._height*100))*10)/1000;
    	option.slides.to.visible = 1-option.slides.from.visible;
    	
    	option.deltaY = Math.abs(odlVisible-option.slides.to.visible);
    	animateSlider();  	
    });
    
>>>>>>> v2
    
    function animateSlider() { 
    	if (option.position.toDown) {
	    	switch (option.slides.from.num) { 
	    		case 0:
	    			var $slide = $('.slide.slide-2');
	    			$slide.find('.iphone-content.iphone-content-0').css('opacity', option.slides.from.visible);	
	    			$slide.find('.iphone-content.iphone-content-1').css('opacity', option.slides.to.visible);
	    			if (option.slides.to.visible>=0.5) {
	    				var w = 2000*((0.5-(1-option.slides.to.visible))/0.5);
	    				$('.gistogramma').width(w);    				
	    			}	    			
	    		break;
	    		case 1:
	    			var $slide = $('.slide.slide-2');
	    			$slide.find('.iphone-content.iphone-content-0').css('opacity', 0);	    			
	    			$slide.find('.iphone-content.iphone-content-1').css('opacity', option.slides.from.visible);	
	    			$slide.find('.iphone-content.iphone-content-2').css('opacity', option.slides.to.visible);  			
	    			if (option.slides.to.visible >= 0.2) {
	    				var _top = 50*(0.8-(1-option.slides.to.visible))/0.8;
	    				$('.favorite').css('top', _top+'%');
	    				if (_top > 47) {
	    					$('.favorite-shadow').css('opacity', 1);
	    				}		
	    			}
	    			$('.gistogramma').width(2000);	    			    			    		
	    		break;
	    		case 2:
	    			var $slide = $('.slide.slide-2');
	    			$slide.find('.iphone-content.iphone-content-0').css('opacity', 0);	    			
	    			$slide.find('.iphone-content.iphone-content-1').css('opacity', 0);
	    			var $iphone = $slide.find('.iphone');
	    			if ($iphone.css('position') == 'fixed') {
	    				$iphone.css({'position': 'absolute'});
	    				$slide.find('.iphone-content.iphone-content-2').css('opacity', 1);
	    				$('.favorite').css({'top': '50%', 'opacity': 1});
	    				$('.favorite-shadow').css('opacity', 1);	    				
	    			}
	    			$('.gistogramma').hide();
	    			
	    			if (option.slides.to.visible >= 0.2) {
	    				var angle = (180-(option.arc.sAngle)*2)/2;
	    				var newangle = option.arc.sAngle + angle*((0.8-(1-option.slides.to.visible))/0.8);
	    				var cX = option.arc.centerX - Math.cos(degToRad(newangle)) * option.arc.radius;
	    				var cY = option.arc.centerY - Math.sin(degToRad(newangle)) * option.arc.radius;
	    				sunDraw(cX, cY);
	    			}    			 		
	    		break;
	    		case 3:
				 		if ($('.background-wrapper .background-slide3').css('opacity') == 0) {
							$('.background-wrapper .background-slide3').css('opacity', 1);						
							if (option.slides.from.visible>0.7) {
								$('.background-wrapper').css({
									'height': 100+(100-100*option.slides.from.visible)+'%',
									'top' : -option._height*(1-option.slides.from.visible)
								});	
							}						
						}
		  			$('.background-wrapper').addClass('slide-3');
		  			$('.slider .slide-3').removeClass('with-background-slide3');
		  			$('.slider .slide-3 .clouds-glare').css('opacity', 0);
		  			    					   							    		
	    			var $slide = $('.slide.slide-2');
	    			var $iphone = $slide.find('.iphone');
	    			if ($iphone.css('position') == 'fixed') {
	    				$iphone.css({'position': 'absolute'});
	    				$slide.find('.iphone-content.iphone-content-0').css('opacity', 0);	    			
	    				$slide.find('.iphone-content.iphone-content-1').css('opacity', 0);	    				
	    				$slide.find('.iphone-content.iphone-content-2').css('opacity', 1);
	    				$('.favorite').css({'top': '50%', 'opacity': 1});
	    				$('.favorite-shadow').css('opacity', 1);
	    			}	    		
	    			if (!$('.background-wrapper').hasClass('slide-3')) {
				 			if ($('.background-wrapper .background-slide3').css('opacity') == 0)
								$('.background-wrapper .background-slide3').css('opacity', 1);
		  				$('.background-wrapper').addClass('slide-3');
		  				$('.slider .slide-3').removeClass('with-background-slide3');
		  				$('.slider .slide-3 .clouds-glare').css('opacity', 0);
	    			}
	    			
	    			var maxangle = 180-option.arc.sAngle-1,
	    				angle = 0;
	    			
	    			if (option.slides.to.visible>0 && option.slides.to.visible <= 0.4 && angle <= maxangle) {
	    				var angle = (180-(option.arc.sAngle)*2);
	    				angle = angle/2+option.arc.sAngle + angle*((0.8-(0.8-option.slides.to.visible))/0.8);
	    				if (angle>=maxangle) angle = maxangle;
	    				console.log([maxangle, angle]);
	    				var cX = option.arc.centerX - Math.cos(degToRad(angle)) * option.arc.radius;
	    				var cY = option.arc.centerY - Math.sin(degToRad(angle)) * option.arc.radius+$('.sun').height()*option.slides.to.visible; // $('.sun').height()*option.slides.to.visible  тупая подгонка
	    				sunDraw(cX, cY);	    				
	    			}
	    			
	  				$('.background-wrapper .background-slide3').css('opacity', option.slides.from.visible);
	  				$('.background-wrapper .background-slide4').css('opacity', option.slides.to.visible);	    							   		
	    		break;
	    	}
    	}
    	else { 		
	    	switch (option.slides.from.num) {
	    		case 1:
	    			var $slide = $('.slide.slide-2');
	    			$slide.find('.iphone-content.iphone-content-1').css('opacity', option.slides.from.visible);	
	    			$slide.find('.iphone-content.iphone-content-0').css('opacity', option.slides.to.visible);
	    			if (option.slides.to.visible >= 0 && option.slides.to.visible <= 0.5) {
	    				var w = 2000 - 2000*((0.5-(0.5-option.slides.to.visible))/0.5);
	    				$('.gistogramma').width(w);    				
	    			}	
	    			else
	    				$('.gistogramma').width(0);		    			    		
	    		break;
	    		case 2:
	    			var $slide = $('.slide.slide-2');
	    			$slide.find('.iphone-content.iphone-content-2').css('opacity', option.slides.from.visible);	
	    			$slide.find('.iphone-content.iphone-content-1').css('opacity', option.slides.to.visible);
	    			var $iphone = $slide.find('.iphone');
	    			if ($iphone.css('position') == 'absolute') {
	    				$iphone.css({
	    					'position': 'fixed',
	    				});
	    			}    				
		    		if (option.slides.to.visible >= 0 && option.slides.to.visible <= 1) {
		    			$('.favorite-shadow').css('opacity', 0);
		    			var _top = 50*(0.8-(0.8-option.slides.to.visible))/0.8;
		    			_top = 50 - _top;
		    			$('.favorite').css('top', _top+'%');	
		    		}	
		    		if (parseInt($('.favorite').css('top'),10) < -50) $('.favorite').css('top', '-50%');		    				
	    			$('.gistogramma').show();
	    		break;
	    		case 3:
				 		if ($('.background-wrapper .background-slide3').css('opacity') == 1)
								$('.background-wrapper .background-slide3').css('opacity', 0);
		  			$('.background-wrapper').removeClass('slide-3');
		  			$('.slider .slide-3').addClass('with-background-slide3');
		  			$('.slider .slide-3 .clouds-glare').css('opacity', 1);
	    			if (option.slides.from.visible >= 0) {
	    				var angle = (180-(option.arc.sAngle)*2)/2;
	    				var newangle = option.arc.sAngle + angle*((0.8-(1-option.slides.from.visible))/0.8);
	    				var cX = option.arc.centerX - Math.cos(degToRad(newangle)) * option.arc.radius;
	    				var cY = option.arc.centerY - Math.sin(degToRad(newangle)) * option.arc.radius;
	    				sunDraw(cX, cY);
	    			} 		  			    					   								    		
	    		break;
	    		case 4:
	    			if (!$('.background-wrapper').hasClass('slide-3')) {
				 			if ($('.background-wrapper .background-slide3').css('opacity') == 0)
								$('.background-wrapper .background-slide3').css('opacity', 1);
		  				$('.background-wrapper').addClass('slide-3');
		  				$('.slider .slide-3').removeClass('with-background-slide3');
		  				$('.slider .slide-3 .clouds-glare').css('opacity', 0);
	    			}	    		
	  				$('.background-wrapper .background-slide4').css('opacity', option.slides.from.visible);
	  				$('.background-wrapper .background-slide3').css('opacity', option.slides.to.visible);
	    			if (option.slides.from.visible>=0 && option.slides.from.visible <= 0.4) {
	    				var angle = (180-(option.arc.sAngle)*2);
	    				var newangle = angle/2+option.arc.sAngle + angle*((0.8-(0.8-option.slides.from.visible))/0.8);
	    				if (newangle > 180-(option.arc.sAngle)-1) newangle = 180-(option.arc.sAngle)-1;
	    				var cX = option.arc.centerX - Math.cos(degToRad(newangle)) * option.arc.radius;
	    				var cY = option.arc.centerY - Math.sin(degToRad(newangle)) * option.arc.radius+$('.sun').height()*option.slides.from.visible;  //тупая подгонка
	    				sunDraw(cX, cY);
	    			}		    			
	    		break;    		    		    		    			
	    	}
	    }    	   		
    }
    
		
		$(window).resize(function() {
	    //clearTimeout($.data(this, 'resizeTimer'));
	    //$.data(this, 'resizeTimer', setTimeout(function() {
	 		$(window).trigger('resizeEnd');
	    //}, 100));    
		});
	
		$(window).bind('resizeEnd', function() {
			option._width = $('body').width();
			option._height = $('body').height();
			arcDraw();
			$(window).trigger('scroll');
		});
		
		function arcDraw () {
			var maxW = 2000;
			var minW = 1024;
			var w = (option._width>maxW?maxW:option._width);
			w = (w<minW?minW:w);
			var h = option._height;
			
			console.log([w, h]);
			
			var a = w;
			option.arc.radius = Math.sqrt(Math.pow(a, 2)+Math.pow(a/2, 2));
			option.arc.centerY = option.arc.radius+10;
			option.arc.centerX = w/2;
			$('.arc').width(w);
			$('.arc').height(h);
			$('.arc').css({
				'margin-top': option._height*-0.3,
				'margin-left': w*-0.5
			});	
		
			var tangA = a/(w/2);
			var sAngle = Math.atan(tangA); //начальный угол в радианах
			option.arc.sAngle = radToDeg(sAngle);// начальный угод в градусах
			
			var eAngle = degToRad(360-radToDeg(sAngle)); //конечный угол в радианах
			sAngle = degToRad(180 + radToDeg(sAngle));//начальный угол в радианах
			
			var web_canvas = document.getElementById('arc');
			var web_context = web_canvas.getContext("2d");
			web_canvas.width = w;
			web_canvas.height = h;
			web_context.arc(option.arc.centerX, option.arc.centerY, option.arc.radius, sAngle, eAngle, false);		
   		web_context.lineWidth = 3;
    	web_context.strokeStyle = "#fff"; 
    	web_context.stroke();			
		}	
		
		function sunDraw(cX, cY) {
			$('.sun').css({'left': cX, 'top': cY}).show();
		}
		
		function degToRad (deg) { 
			return deg / 180 * Math.PI; 
		}

		function radToDeg (rad) { 
			return rad / Math.PI * 180; 
		}
		
		$('.arrow a').on('click', function(e) {
			e.preventDefault();	
			_top= -100;	
<<<<<<< HEAD
      _animateSlide();   					
=======
      bStarted = true;
			$(window).scrollTop(option._height);				
>>>>>>> v2
		});	    	
	}
})(jQuery);